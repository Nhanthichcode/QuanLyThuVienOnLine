<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title><%= title %> - Thư Viện Online</title>

    <link rel="stylesheet" href="/CSS/app.css" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />

    <style>
      .site-footer .nav-link {
        color: #fff !important;
        opacity: 0.92;
        transition: color 0.2s, text-transform 0.2s;
      }
      .site-footer .nav-link:hover {
        color: #cd0d47 !important;
        opacity: 1;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .main-book-list {
        max-height: 650px;
        min-height: 400px;
        overflow-y: auto;
        padding-right: 8px;
      }
      .main-book-list .card {
        margin-bottom: 16px;
        transition: all 0.3s;
        border: 1px solid rgba(0, 0, 0, 0.12);
      }
      .main-book-list .card:hover {
        transform: translateY(-5px) scale(1.03);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
        z-index: 2;
      }
      .main-book-list .card:hover .badge {
        transform: scale(1.1);
        background-color: #198754 !important;
      }
      .main-book-list .card:hover .card-title {
        color: #0d6efd;
      }
      .main-book-list .add-to-cart {
        transition: all 0.2s;
      }
      .main-book-list .card:hover .add-to-cart {
        transform: scale(1.08);
      }
      @media (max-width: 991.98px) {
        .main-book-list {
          max-height: 400px;
        }
      }
      @media (max-width: 767.98px) {
        .main-book-list {
          max-height: 300px;
        }
      }
      .book-img {
        height: 120px;
        object-fit: cover;
      }
      .sidebar-section {
        max-height: 320px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <%- include('navbar') %>
    <div class="container text-center my-4">
      <h1 class="display-4">Khám phá hàng nghìn cuốn sách tuyệt vời</h1>
      <p class="lead text-muted">Thư viện online dành cho mọi độc giả.</p>
    </div>

    <main class="container py-4">
      <div class="row">
        <!-- Danh sách sách (bên trái) -->
        <div class="col-md-9">
          <h2 class="mb-4 text-start"><%= title %></h2>
          <div class="main-book-list">
            <% if (sach && sach.length > 0) { %>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
              <% sach.forEach(function(book) { %>
              <div class="col">
                <div class="card h-100 shadow-sm">
                  <div class="position-relative">
                    <img
                      src="/uploads/<%= book.HinhAnh %>"
                      class="card-img-top book-img"
                      alt="<%= book.TieuDe %>"
                      onerror="this.onerror=null;this.src='/uploads/null.png';"
                    />
                    <div class="position-absolute top-0 end-0 m-2">
                      <span class="badge bg-success fs-6">
                        <%= book.GiaBan.toLocaleString('vi-VN') %> đ
                      </span>
                    </div>
                  </div>
                  <div class="card-body p-2">
                    <h5
                      class="card-title text-truncate mb-1"
                      style="font-size: 1.05em"
                    >
                      <%= book.TieuDe %>
                    </h5>
                    <p class="card-text mb-1">
                      <small class="text-muted">
                        <i class="bi bi-person"></i> <%= book.TacGia %>
                      </small>
                    </p>
                    <p class="card-text mb-0">
                      <small class="text-muted">
                        <i class="bi bi-eye"></i> <%= book.LuotXem %> lượt xem
                      </small>
                    </p>
                  </div>
                  <div class="card-footer bg-white border-top-0 py-2">
                    <div
                      class="d-flex justify-content-between align-items-center"
                    >
                      <a
                        href="/sach/sach_chitiet/<%= book._id %>"
                        class="btn btn-outline-primary btn-sm"
                      >
                        <i class="bi bi-info-circle"></i> Chi tiết
                      </a>
                      <% if(session.QuyenHan !=='admin') { %>
                      <button
                        class="btn btn-success btn-sm add-to-cart"
                        data-book-id="<%= book._id %>"
                        onclick="addToCart('<%= book._id %>')"
                        title="Thêm vào giỏ hàng"
                      >
                        <i class="bi bi-cart-plus"></i>
                      </button>
                      <% }%>
                    </div>
                  </div>
                </div>
              </div>
              <% }); %>
            </div>
            <% } else { %>
            <p class="text-center">Không có sách nào được tìm thấy.</p>
            <% } %>
          </div>
        </div>

        <!-- Sidebar (Bên phải) -->
        <div class="col-md-3">
          <!-- Chủ đề phổ biến -->
          <div class="card mb-4 sidebar-section">
            <div class="card-body">
              <h4 class="card-title">Chủ đề phổ biến</h4>
              <% if (typeof chuyenmuc !== "undefined") { %> <%
              chuyenmuc.forEach(function(cd) { %>
              <a
                class="btn btn-outline-primary btn-sm mb-1"
                href="/sach/chude/<%= cd._id %>"
                ><%= cd.TenChuDe %></a
              >
              <% }); %> <% } %>
            </div>
          </div>

          <!-- Xem nhiều nhất -->
          <div class="card mb-4 sidebar-section">
            <div class="card-body" style="text-decoration: none !important">
              <h4 class="card-title">Xem nhiều nhất</h4>
              <% if (typeof xemnhieunhat !== "undefined") { %> <%
              xemnhieunhat.forEach(function(book) { %>
              <a href="/sach/sach_chitiet/<%= book._id %>" class="d-block mb-3">
                <h6 class="mb-1"><%= book.TenSach %></h6>
                <p class="text-warning">
                  <i class="bi bi-eye-fill"></i> <%= book.LuotXem %> lượt xem
                </p>
                <img
                  src="/uploads/<%= book.HinhAnh %>"
                  class="img-fluid rounded"
                  alt="<%= book.TenSach %>"
                  onerror="this.onerror=null;this.src='/uploads/null.png';"
                />
              </a>
              <hr />
              <% }); %> <% } %>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="site-footer bg-dark text-white py-4">
      <div class="container text-center">
        <ul class="nav justify-content-center mb-2">
          <li class="nav-item">
            <a class="nav-link" href="#">Chính sách riêng tư</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dangky">Đăng ký</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dangnhap">Đăng nhập</a>
          </li>
          <li class="nav-item"><a class="nav-link" href="#">Liên hệ</a></li>
        </ul>
        <p>&copy; 2025 Thư Viện Online của Lê Trí Nhàn & Đàm Thanh Phong</p>
      </div>
    </footer>

    <script>
      async function addToCart(sachId) {
        try {
          var taikhoanID = "<%= session.MaNguoiDung %>";
          if (taikhoanID == null || taikhoanID == "") {
            alert("Vui lòng đăng nhập để thêm sách vào giỏ hàng.");
            window.location.href = "/dangnhap";
            return;
          }

          const response = await fetch("/giohang/them/" + sachId, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              sachId: sachId,
              soLuong: 1,
            }),
          });

          const data = await response.json();

          if (data.success) {
            alert("Thêm sách vào giỏ hàng thành công!");
            setTimeout(() => location.reload(), 500);
          } else {
            alert(data.message || "Có lỗi xảy ra khi thêm sách vào giỏ hàng.");
          }
        } catch (error) {
          console.log("Lỗi:" + error);
          alert("Có lỗi xảy ra khi thêm sách vào giỏ hàng.");
        }
      }
    </script>
  </body>
</html>
