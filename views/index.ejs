<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title><%= title %> - Thư Viện Online</title>

    <!-- <link rel="stylesheet" href="/CSS/app.css" /> -->

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />

    <style>
      .site-footer .nav-link {
        color: #fff !important;
        opacity: 0.92;
        transition: color 0.2s, text-transform 0.2s;
        text-decoration: none;
      }
      .site-footer .nav-link:hover {
        color: #cd0d47 !important;
        opacity: 1;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .main-book-list {
        max-height: 650px;
        min-height: 400px;
        overflow-y: auto;
        padding-right: 8px;
      }
      .main-book-list .card {
        margin-bottom: 16px;
        transition: all 0.3s;
        border: 1px solid rgba(0, 0, 0, 0.12);
      }
      .main-book-list .card:hover {
        transform: translateY(-5px) scale(1.03);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
        z-index: 2;
      }
      .main-book-list .card:hover .badge {
        transform: scale(1.1);
        background-color: #198754 !important;
      }
      .main-book-list .card:hover .card-title {
        color: #0d6efd;
      }
      .main-book-list .add-to-cart {
        transition: all 0.2s;
      }
      .main-book-list .card:hover .add-to-cart {
        transform: scale(1.08);
      }
      .book-glass-card {
        min-height: 260px;
        max-height: 340px;
        background: #222;
        border-radius: 18px;
        overflow: hidden;
        position: relative;
      }
      .book-img {
        width: 100%;
        height: 100%;
        min-height: 220px;
        max-height: 320px;
        object-fit: cover;
        display: block;
        border-radius: 18px;
        transition: transform 0.3s;
      }
      .book-glass-card:hover .book-img {
        transform: scale(1.04);
        filter: brightness(0.95) blur(1px);
      }
      .book-info-glass {
        background: rgba(30, 30, 40, 0.68);
        backdrop-filter: blur(6px);
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
        color: #fff;
        box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.18);
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
      }
      .book-info-glass .btn-outline-light {
        border-color: #fff;
        color: #fff;
        padding: 0.2rem 0.6rem;
      }
      .book-info-glass .btn-outline-light:hover {
        background: #fff;
        color: #222;
      }
      @media (max-width: 767.98px) {
        .book-glass-card {
          min-height: 180px;
          max-height: 220px;
        }
        .book-img {
          min-height: 140px;
          max-height: 180px;
        }
        .book-info-glass {
          font-size: 0.95em;
          padding: 0.7em 1em;
        }
      }
      @media (max-width: 991.98px) {
        .main-book-list {
          max-height: 400px;
        }
      }
      @media (max-width: 767.98px) {
        .main-book-list {
          max-height: 300px;
        }
      }
      .book-img {
        height: 120px;
        object-fit: cover;
      }
      .sidebar-section {
        max-height: 320px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <%- include('navbar') %>
    <div class="container text-center my-4">
      <h1 class="display-4">Khám phá hàng nghìn cuốn sách tuyệt vời</h1>
      <p class="lead text-muted">Thư viện online dành cho mọi độc giả.</p>
    </div>

    <main class="container py-4">
      <div class="row">
        <!-- Danh sách sách (bên trái) -->
        <div class="col-md-9">
          <h2 class="mb-4 text-start"><%= title %></h2>
          <div class="main-book-list">
            <% if (sach && sach.length > 0) { %>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
              <% sach.forEach(function(book) { %>
              <div class="col">
                <div
                  class="card h-100 shadow-sm border-0 position-relative overflow-hidden book-glass-card"
                >
                  <img
                    src="/uploads/<%= book.HinhAnh %>"
                    class="card-img book-img"
                    alt="<%= book.TieuDe %>"
                    style="
                      object-fit: cover;
                      width: 100%;
                      height: 100%;
                      min-height: 220px;
                      max-height: 320px;
                    "
                    onerror="this.onerror=null;this.src='/uploads/null.png';"
                  />
                  <!-- Glass info footer -->
                  <div
                    class="book-info-glass w-100 px-3 py-2 position-absolute bottom-0 start-0"
                  >
                    <h5
                      class="card-title text-truncate mb-1 text-white"
                      style="font-size: 1.08em"
                    >
                      <%= book.TieuDe %>
                    </h5>
                    <div
                      class="d-flex justify-content-between align-items-center mb-1"
                    >
                      <span class="text-light small"
                        ><i class="bi bi-person"></i> <%= book.TacGia %></span
                      >
                      <span class="badge bg-success fs-6 shadow-sm">
                        <%= book.GiaBan.toLocaleString('vi-VN') %> đ
                      </span>
                    </div>
                    <div
                      class="d-flex justify-content-between align-items-center"
                    >
                      <span class="text-warning small"
                        ><i class="bi bi-eye"></i> <%= book.LuotXem %></span
                      >
                      <div>
                        <a
                          href="/sach/sach_chitiet/<%= book._id %>"
                          class="btn btn-outline-light btn-sm me-1"
                          title="Chi tiết"
                        >
                          <i class="bi bi-info-circle"> Chi tiết</i>
                        </a>
                        <% if(session.QuyenHan !=='admin') { %>
                        <button
                          class="btn btn-success btn-sm add-to-cart"
                          data-book-id="<%= book._id %>"
                          onclick="addToCart('<%= book._id %>')"
                          title="Thêm vào giỏ hàng"
                        >
                          <i class="bi bi-cart-plus"></i>
                        </button>
                        <% } %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <% }); %>
            </div>
            <% } else { %>
            <p class="text-center">Không có sách nào được tìm thấy.</p>
            <% } %>
          </div>
        </div>

        <!-- Sidebar (Bên phải) -->
        <div class="col-md-3">
          <!-- Chủ đề phổ biến -->
          <div class="card mb-4 sidebar-section">
            <div class="card-body">
              <h4 class="card-title">Chủ đề phổ biến</h4>
              <% if (typeof chuyenmuc !== "undefined") { %> <%
              chuyenmuc.forEach(function(cd) { %>
              <a
                class="btn btn-outline-primary btn-sm mb-1"
                href="/sach/chude/<%= cd._id %>"
                ><%= cd.TenChuDe %></a
              >
              <% }); %> <% } %>
            </div>
          </div>

          <!-- Xem nhiều nhất -->
          <div class="card mb-4 sidebar-section">
            <div class="card-body" style="text-decoration: none !important">
              <h4 class="card-title">Xem nhiều nhất</h4>
              <% if (typeof xemnhieunhat !== "undefined") { %> <%
              xemnhieunhat.forEach(function(book) { %>
              <a
                href="/sach/sach_chitiet/<%= book._id %>"
                class="d-block mb-3 nav-link"
              >
                <h6 class="mb-1"><%= book.TenSach %></h6>
                <p class="text-warning">
                  <i class="bi bi-eye-fill"></i> <%= book.LuotXem %> lượt xem
                </p>
                <img
                  src="/uploads/<%= book.HinhAnh %>"
                  class="img-fluid rounded"
                  alt="<%= book.TenSach %>"
                  onerror="this.onerror=null;this.src='/uploads/null.png';"
                />
              </a>
              <hr />
              <% }); %> <% } %>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="site-footer bg-dark text-white py-4">
      <div class="container text-center">
        <ul class="nav justify-content-center mb-2">
          <li class="nav-item">
            <a class="nav-link" href="#">Chính sách riêng tư</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dangky">Đăng ký</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dangnhap">Đăng nhập</a>
          </li>
          <li class="nav-item"><a class="nav-link" href="#">Liên hệ</a></li>
        </ul>
        <p>&copy; 2025 Thư Viện Online của Lê Trí Nhàn & Đàm Thanh Phong</p>
      </div>
    </footer>

    <%- include('javascript') %>

    <script>
      async function addToCart(sachId) {
        try {
          var taikhoanID = "<%= session.MaNguoiDung %>";
          if (taikhoanID == null || taikhoanID == "") {
            alert("Vui lòng đăng nhập để thêm sách vào giỏ hàng.");
            window.location.href = "/dangnhap";
            return;
          }

          const response = await fetch("/giohang/them/" + sachId, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              sachId: sachId,
              soLuong: 1,
            }),
          });

          const data = await response.json();

          if (data.success) {
            alert("Thêm sách vào giỏ hàng thành công!");
            setTimeout(() => location.reload(), 500);
          } else {
            alert(data.message || "Có lỗi xảy ra khi thêm sách vào giỏ hàng.");
          }
        } catch (error) {
          console.log("Lỗi:" + error);
          alert("Có lỗi xảy ra khi thêm sách vào giỏ hàng.");
        }
      }
    </script>
  </body>
</html>
