<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %> - Thư Viện Online</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <style>
      .quantity-control {
        width: 120px;
      }
      .book-image {
        width: 100px;
        height: 150px;
        object-fit: cover;
      }
    </style>
  </head>
  <body>
    <%- include('navbar') %>

    <div class="container py-5">
      <h1 class="mb-4"><i class="bi bi-cart3"></i> Giỏ hàng của tôi</h1>

      <% if (taikhoan.GioHang && taikhoan.GioHang.length > 0) { %>
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Sách</th>
                  <th>Tên sách</th>
                  <th>Giá</th>
                  <th>Số lượng</th>
                  <th>Thành tiền</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% let tongTien = 0 %> <%
                taikhoan.GioHang.forEach(function(item) { %> <% tongTien +=
                item.Sach.GiaBan * item.SoLuong %>
                <tr>
                  <td>
                    <img
                      src="/uploads/<%= item.Sach.HinhAnh || 'default.jpg' %>"
                      class="book-image rounded"
                      alt="<%= item.Sach.TieuDe %>"
                    />
                  </td>
                  <td>
                    <h5 class="mb-0"><%= item.Sach.TieuDe %></h5>
                    <small class="text-muted"
                      >Tác giả: <%= item.Sach.TacGia %></small
                    >
                  </td>
                  <td><%= item.Sach.GiaBan.toLocaleString('vi-VN') %> đ</td>
                  <td>
                    <div class="quantity-control input-group">
                      <button
                        class="btn btn-outline-secondary"
                        onclick="updateQuantity('<%= item.Sach._id %>', -1)"
                      >
                        <i class="bi bi-dash"></i>
                      </button>
                      <input
                        type="number"
                        class="form-control text-center"
                        value="<%= item.SoLuong %>"
                        min="1"
                        onchange="updateQuantity('<%= item.Sach._id %>', this.value)"
                      />
                      <button
                        class="btn btn-outline-secondary"
                        onclick="updateQuantity('<%= item.Sach._id %>', 1)"
                      >
                        <i class="bi bi-plus"></i>
                      </button>
                    </div>
                  </td>
                  <td>
                    <%= (item.Sach.GiaBan *
                    item.SoLuong).toLocaleString('vi-VN') %> đ
                  </td>
                  <td>
                    <button
                      class="btn btn-danger btn-sm"
                      onclick="removeFromCart('<%= item.Sach._id %>')"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
                <% }); %>
              </tbody>
              <tfoot>
                <tr class="table-active">
                  <td colspan="4" class="text-end">
                    <strong>Tổng tiền:</strong>
                  </td>
                  <td>
                    <strong><%= tongTien.toLocaleString('vi-VN') %> đ</strong>
                  </td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div class="card-footer text-end">
          <a href="/" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Tiếp tục mua sắm
          </a>
          <button class="btn btn-primary" onclick="checkout()">
            Thanh toán <i class="bi bi-arrow-right"></i>
          </button>
        </div>
      </div>
      <% } else { %>
      <div class="text-center py-5">
        <i class="bi bi-cart-x display-1 text-muted"></i>
        <h3 class="mt-3">Giỏ hàng trống</h3>
        <p class="text-muted">Bạn chưa có sản phẩm nào trong giỏ hàng</p>
        <a href="/" class="btn btn-primary">
          <i class="bi bi-shop"></i> Tiếp tục mua sắm
        </a>
      </div>
      <% } %>
    </div>

    <script>
      function updateQuantity(sachId, change) {
        fetch(`/giohang/capnhat/${sachId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ change: change }),
        }).then(() => location.reload());
      }

      function removeFromCart(sachId) {
        if (confirm("Bạn có chắc muốn xóa sách này khỏi giỏ hàng?")) {
          fetch(`/giohang/xoa/${sachId}`, {
            method: "POST",
          }).then(() => location.reload());
        }
      }

      function checkout() {
        window.location.href = "/thanhtoan";
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
